name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Release ZIP
        run: |
          TAG_NAME="${{ github.ref_name }}"
          ZIP_NAME="dongliTV-$TAG_NAME.zip"
          echo "üì¶ ÂàõÂª∫ÂèëÂ∏ÉÂåÖ: $ZIP_NAME"
          git archive --format=zip HEAD -o "$ZIP_NAME"
          ls -lh "$ZIP_NAME"
          echo "RELEASE_ZIP=$ZIP_NAME" >> $GITHUB_ENV

      - name: Generate and Upload version.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ github.ref_name }}"
          ZIP_FILE="${{ env.RELEASE_ZIP }}"

          FILE_SIZE=$(stat -c%s "$ZIP_FILE")
          FILE_SHA256=$(sha256sum "$ZIP_FILE" | cut -d' ' -f1)

          VERSION_NAME="${TAG_NAME#v}"
          
          # Ëé∑ÂèñÂΩìÂâçÊó•Êúü
          UPDATE_DATE=$(date +%Y-%m-%d)

          if [[ $TAG_NAME =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            MAJOR=${BASH_REMATCH[1]}
            MINOR=${BASH_REMATCH[2]}
            PATCH=${BASH_REMATCH[3]}
            VERSION_CODE=$(( MAJOR * 10000 + MINOR * 100 + PATCH ))
          else
            VERSION_CODE=$(( 1000000 + $(date +%s) ))
          fi

          JSON_CONTENT=$(cat <<EOF
          {
            "versionName": "$VERSION_NAME",
            "versionCode": $VERSION_CODE,
            "url": "https://github.com/chitue/dongliTV/releases/download/$TAG_NAME/$ZIP_FILE",
            "size": $FILE_SIZE,
            "sha256": "$FILE_SHA256",
            "updateDate": "$UPDATE_DATE",
            "releaseNotes": "‰øÆÂ§çÂ∑≤Áü•ÈóÆÈ¢òÔºåÊèêÂçáÁ®≥ÂÆöÊÄß"
          }
          EOF
          )
          echo "üìÑ ÁîüÊàêÁöÑ version.json ÂÜÖÂÆπÔºö"
          echo "$JSON_CONTENT"

          CONTENT_B64=$(echo "$JSON_CONTENT" | base64 | tr -d '\n')

          echo "Ëé∑Âèñ version.json ÂΩìÂâçÁä∂ÊÄÅ..."
          API_RESPONSE=$(curl -s -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/contents/version.json" || echo '{}')

          SHA=$(echo "$API_RESPONSE" | grep -o '"sha": "[^"]*"' | cut -d'"' -f4)

          API_JSON=$(cat <<EOF
          {
            "message": "chore: Êõ¥Êñ∞ÁâàÊú¨‰ø°ÊÅØËá≥ $TAG_NAME",
            "content": "$CONTENT_B64"
          }
          EOF
          )

          if [ -n "$SHA" ]; then
            API_JSON=$(echo "$API_JSON" | jq --arg sha "$SHA" '. + {sha: $sha}')
          fi

          echo "ÈÄöËøáAPIÊèê‰∫§ version.json ..."
          curl -X PUT -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            -d "$API_JSON" \
            "https://api.github.com/repos/${{ github.repository }}/contents/version.json"
          echo "‚úÖ version.json Â∑≤ÊàêÂäüÊõ¥Êñ∞ÔºÅ"

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          files: |
            ${{ env.RELEASE_ZIP }}